FROM alpine:3.19

ARG GO_VERSION=1.24.0
ARG TREE_SITTER_VERSION=0.24.7

RUN apk add --no-cache bash ca-certificates curl python3 py3-pip python3-dev nodejs-current npm build-base linux-headers rust cargo git gcompat libc6-compat \
  && update-ca-certificates \
  && ln -sf /usr/bin/python3 /usr/bin/python \
  && curl -fsSL "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v${TREE_SITTER_VERSION}.tar.gz" \
  | tar -xz -C /tmp \
  && cd "/tmp/tree-sitter-${TREE_SITTER_VERSION}" \
  && make \
  && make install \
  && install -d '/usr/local/include/tree_sitter' \
  && cp -f lib/include/tree_sitter/*.h '/usr/local/include/tree_sitter/' \
  && cp -f lib/src/*.h '/usr/local/include/tree_sitter/' \
  && if [ -d lib/src/tree_sitter ]; then cp -f lib/src/tree_sitter/*.h '/usr/local/include/tree_sitter/'; fi \
  && cd / \
  && rm -rf "/tmp/tree-sitter-${TREE_SITTER_VERSION}" \
  && cargo install --locked --root /usr/local tree-sitter-cli --version 0.24.7

RUN arch="$(uname -m)" \
  && case "$arch" in x86_64) go_arch="amd64" ;; aarch64|arm64) go_arch="arm64" ;; *) echo "unsupported arch: $arch" && exit 1 ;; esac \
  && curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${go_arch}.tar.gz" \
  | tar -C /usr/local -xz

ENV PATH="/usr/local/go/bin:${PATH}"

WORKDIR /app
COPY . /app

RUN go build -o /usr/local/bin/monadscli ./cmd/monadscli

RUN chmod +x /app/test/docker/install-and-verify.sh

CMD ["/app/test/docker/install-and-verify.sh"]

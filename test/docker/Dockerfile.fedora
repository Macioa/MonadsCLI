FROM fedora:40

ARG GO_VERSION=1.24.0

RUN dnf -y install ca-certificates curl git tar gzip python3 python3-pip python3-devel gcc \
  && curl -fsSL https://rpm.nodesource.com/setup_22.x | bash - \
  && dnf -y install nodejs \
  && dnf clean all \
  && ln -sf /usr/bin/python3 /usr/bin/python

RUN arch="$(uname -m)" \
  && case "$arch" in x86_64) go_arch="amd64" ;; aarch64|arm64) go_arch="arm64" ;; *) echo "unsupported arch: $arch" && exit 1 ;; esac \
  && curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${go_arch}.tar.gz" \
  | tar -C /usr/local -xz

ENV PATH="/usr/local/go/bin:${PATH}"

WORKDIR /app
COPY . /app

RUN go build -o /usr/local/bin/monadscli ./cmd/monadscli

RUN chmod +x /app/test/docker/install-and-verify.sh

CMD ["/app/test/docker/install-and-verify.sh"]

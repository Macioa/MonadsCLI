FROM mcr.microsoft.com/powershell:7.4-ubuntu-22.04

ARG GO_VERSION=1.20.13

RUN apt-get update \
  && apt-get install -y --no-install-recommends ca-certificates curl tar gzip gnupg \
  && curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
  && apt-get install -y --no-install-recommends nodejs python3 python3-pip python-is-python3 \
  && rm -rf /var/lib/apt/lists/*

RUN arch="$(uname -m)" \
  && case "$arch" in \
    x86_64) go_arch="amd64" ;; \
    aarch64|arm64) go_arch="arm64" ;; \
    *) echo "unsupported arch: $arch" && exit 1 ;; \
  esac \
  && curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${go_arch}.tar.gz" \
  | tar -C /usr/local -xz

ENV PATH="/usr/local/go/bin:${PATH}"

WORKDIR /app
COPY . /app

RUN go build -o /usr/local/bin/monadscli ./cmd/monadscli

RUN chmod +x /app/test/docker/install-and-verify.sh

CMD ["/app/test/docker/install-and-verify.sh"]
